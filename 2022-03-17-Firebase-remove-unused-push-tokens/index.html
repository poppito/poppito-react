<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.32.13"/><title data-react-helmet="true"></title><link rel="icon" href="/favicon-32x32.png?v=5c064402d8c94391a8a5abea59f08f1d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#02aab0"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=5c064402d8c94391a8a5abea59f08f1d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=5c064402d8c94391a8a5abea59f08f1d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=5c064402d8c94391a8a5abea59f08f1d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=5c064402d8c94391a8a5abea59f08f1d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=5c064402d8c94391a8a5abea59f08f1d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=5c064402d8c94391a8a5abea59f08f1d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=5c064402d8c94391a8a5abea59f08f1d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=5c064402d8c94391a8a5abea59f08f1d"/><link as="script" rel="preload" href="/webpack-runtime-edd649ca7eaaa88b0b20.js"/><link as="script" rel="preload" href="/framework-707a8a8db8797361392f.js"/><link as="script" rel="preload" href="/app-547f3a52ec4084ef92af.js"/><link as="script" rel="preload" href="/bf78b62435f1ab13ed4c16dc8a3adc67794e8876-7238c2a62e3c167833ae.js"/><link as="script" rel="preload" href="/component---src-blog-2022-03-17-firebase-remove-unused-push-tokens-mdx-809a2466e361ed84380a.js"/><link as="fetch" rel="preload" href="/page-data/2022-03-17-Firebase-remove-unused-push-tokens/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3649515864.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="blogpage"><a href="/blog" duration="1000">Back</a></div><div class="blogText"><h1 color="#f9f9f9"></h1><div style="margin:0 auto;max-width:960px;padding:0px 1.0875rem 1.45rem;padding-top:0"><div><h1>Invalidating unused Firebase push tokens using scheduled functions</h1><p>Push messaging in modern mobile apps with Firebase is really common. The usual workflow is:</p><ul><li><p>Integrating Firebase push SDKs / Cocoapods / SPM packages within the app.</p></li><li><p>Registering a project on the Firebase console.</p></li><li><p>On native apps, configuring the Firebase library, requesting for notification permissions, obtaining push tokens and saving them to a backend service.</p></li></ul><p>A lot of apps obtain push tokens at login (an optimal way of doing this is by requesting the current token from Firebase&#x27;s local cache). Apps that support multiple users / login, usually also invalidate tokens on logout.
But what if the user never logs out, but removes / uninstall the app? ü§î</p><p>The best way to invalidate these tokens, unfortunately is by looking for errors when a push message is sent outbound, like so:</p><pre><code class="language-js">admin.messaging().sendToDevice(tokens, message, options)
    .then((response) =&gt; {
        console.log(&#x27;Successfully sent message:&#x27;, response);
    }).catch((error) =&gt; {
        if (error.code === &#x27;messaging/invalid-registration-token&#x27; ||
            error.code === &#x27;messaging/registration-token-not-registered&#x27;) {
            //a promise here to delete the token which can be pushed to an array,
            //then return promise.all üëç
        }
    });
</code></pre><p>This is however problematic in apps that a) don&#x27;t want to send out bulk outbound notifications and b) only support async notifications ie. notifications that go out when the
user performs an action.</p><p>There&#x27;s a better way. On closely inspecting the way Firebase functions sends out push notifications, I realised there is a </p><pre><code class="language-js">sendToDevice(registrationToken: string | string[], payload: MessagingPayload, options?: MessagingOptions): Promise&lt;MessagingDevicesResponse&gt;;
</code></pre><p>Here, <code>MessagingOptions</code> has a <code>dryRun?: boolean</code> variable, when set to true, it won&#x27;t actually send the push message but rather do a dry run.</p><p>Essentially, how we can create a <a href="https://firebase.google.com/docs/functions/schedule-functions">scheduled</a> Firebase function that:
a) Polls for all push tokens</p><pre><code class="language-js">for (const [key, value] of tokens.entries()) {
        allTokens.push(key);
}
</code></pre><p>b) sets dry run to true.</p><pre><code class="language-js">    const options = {
        dryRun: true
    }
</code></pre><p>c)  Finally, send out push notifications, poll for errors and remove invalid tokens:</p><pre><code class="language-js">    admin.messaging().sendToDevice(allTokens, message, options)
    .then((response) =&gt; {
        response.results.forEach((deviceResult, index) =&gt; {
            if (deviceResult.error) {
                let failedToken = allTokens[index];
                //push a promise to remove token from db.
            }
        });
    });
    return Promise.all(tokensToRemove);
</code></pre></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2022-03-17-Firebase-remove-unused-push-tokens";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-fd03ea034e94ca1b5dac.js"],"app":["/app-547f3a52ec4084ef92af.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-ad6431e4664bcf916d19.js"],"component---src-blog-2016-12-30-license-details-mdx":["/component---src-blog-2016-12-30-license-details-mdx-7d9b72e6377a254bdfa7.js"],"component---src-blog-2016-12-30-why-dropbox-mdx":["/component---src-blog-2016-12-30-why-dropbox-mdx-fe3628c2c503dacc0c53.js"],"component---src-blog-2016-12-31-privacy-policy-mdx":["/component---src-blog-2016-12-31-privacy-policy-mdx-3163674a9f6b7ea392e0.js"],"component---src-blog-2017-03-31-privacy-policy-straya-mate-mdx":["/component---src-blog-2017-03-31-privacy-policy-straya-mate-mdx-eae2bd0246f01ac7088b.js"],"component---src-blog-2017-11-17-google-play-games-for-fun-and-profit-but-mostly-fun-mdx":["/component---src-blog-2017-11-17-google-play-games-for-fun-and-profit-but-mostly-fun-mdx-88522bd2d0ae90c0096d.js"],"component---src-blog-2017-12-09-app-monetisation-and-in-app-billing-implementation-mdx":["/component---src-blog-2017-12-09-app-monetisation-and-in-app-billing-implementation-mdx-1cbca2d125e0092f30c6.js"],"component---src-blog-2018-03-25-privacy-policy-strayamate-i-os-mdx":["/component---src-blog-2018-03-25-privacy-policy-strayamate-i-os-mdx-a6ee5a15ea77837ae478.js"],"component---src-blog-2018-03-25-privacy-policy-turnt-app-i-os-mdx":["/component---src-blog-2018-03-25-privacy-policy-turnt-app-i-os-mdx-2dbdf5cba68e5622f71a.js"],"component---src-blog-2019-01-13-footy-stars-mdx":["/component---src-blog-2019-01-13-footy-stars-mdx-1ba964bdd4c1b6437444.js"],"component---src-blog-2019-01-30-strayamate-lite-mdx":["/component---src-blog-2019-01-30-strayamate-lite-mdx-38b74eb08a6a11a1b737.js"],"component---src-blog-2019-03-18-testing-android-q-beta-without-an-actual-pixel-device-is-hard-mdx":["/component---src-blog-2019-03-18-testing-android-q-beta-without-an-actual-pixel-device-is-hard-mdx-c0e630d2538427b36a06.js"],"component---src-blog-2019-04-06-in-app-billing-implementation-v-1-2-mdx":["/component---src-blog-2019-04-06-in-app-billing-implementation-v-1-2-mdx-3d7ba7732af908cd50d7.js"],"component---src-blog-2019-04-14-foldable-emulators-in-android-studio-mdx":["/component---src-blog-2019-04-14-foldable-emulators-in-android-studio-mdx-8f3e7849209b7434f7e0.js"],"component---src-blog-2019-05-02-zen-of-conferences-mdx":["/component---src-blog-2019-05-02-zen-of-conferences-mdx-3440e3916397df59e889.js"],"component---src-blog-2019-05-14-privacy-policy-aussie-slang-action-on-google-mdx":["/component---src-blog-2019-05-14-privacy-policy-aussie-slang-action-on-google-mdx-915aa77d084e6aa6d00a.js"],"component---src-blog-2019-06-01-io-2019-a-11-y-mdx":["/component---src-blog-2019-06-01-io-2019-a-11-y-mdx-93fc40a5182f1ada11f9.js"],"component---src-blog-2019-09-28-relasing-an-app-mdx":["/component---src-blog-2019-09-28-relasing-an-app-mdx-de214098a626cd533b0f.js"],"component---src-blog-2019-12-08-huxtable-android-privacy-policy-mdx":["/component---src-blog-2019-12-08-huxtable-android-privacy-policy-mdx-ef59ff4f04ddc641109e.js"],"component---src-blog-2019-12-08-huxtable-privacy-policy-mdx":["/component---src-blog-2019-12-08-huxtable-privacy-policy-mdx-e5bb662eea76773c1e58.js"],"component---src-blog-2019-12-09-huxtable-preview-mdx":["/component---src-blog-2019-12-09-huxtable-preview-mdx-df18105c2089d50c2133.js"],"component---src-blog-2020-02-09-huxtable-preview-android-i-phone-mdx":["/component---src-blog-2020-02-09-huxtable-preview-android-i-phone-mdx-aa608833958ace73b618.js"],"component---src-blog-2020-03-06-privacy-policy-handwash-hygiene-mdx":["/component---src-blog-2020-03-06-privacy-policy-handwash-hygiene-mdx-524f7051fd8a03855798.js"],"component---src-blog-2020-04-25-testing-behaviour-changes-android-11-mdx":["/component---src-blog-2020-04-25-testing-behaviour-changes-android-11-mdx-3747bf1333b58b03f866.js"],"component---src-blog-2020-05-08-particle-paradox-privacy-policy-mdx":["/component---src-blog-2020-05-08-particle-paradox-privacy-policy-mdx-75a5233af37960b46551.js"],"component---src-blog-2020-08-22-in-app-reviews-play-core-api-mdx":["/component---src-blog-2020-08-22-in-app-reviews-play-core-api-mdx-96aca1cc828b2dde8a41.js"],"component---src-blog-2020-12-26-a-neat-trick-for-testing-on-the-play-store-mdx":["/component---src-blog-2020-12-26-a-neat-trick-for-testing-on-the-play-store-mdx-847008811f85661f4be0.js"],"component---src-blog-2021-04-14-privacy-policy-anzac-day-stickers-mdx":["/component---src-blog-2021-04-14-privacy-policy-anzac-day-stickers-mdx-109ba25e5820eb424d12.js"],"component---src-blog-2021-04-22-privacy-policy-family-stickers-mdx":["/component---src-blog-2021-04-22-privacy-policy-family-stickers-mdx-91488d82e75322d70b81.js"],"component---src-blog-2022-03-17-firebase-remove-unused-push-tokens-mdx":["/component---src-blog-2022-03-17-firebase-remove-unused-push-tokens-mdx-809a2466e361ed84380a.js"],"component---src-pages-404-js":["/component---src-pages-404-js-d9840f808c3274806851.js"],"component---src-pages-app-ads-txt-js":["/component---src-pages-app-ads-txt-js-f751c8fb80fb9dafe579.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js-6974499739183b1558dd.js"],"component---src-pages-index-js":["/component---src-pages-index-js-ab557970cb5442eb004f.js"]};/*]]>*/</script><script src="/polyfill-fd03ea034e94ca1b5dac.js" nomodule=""></script><script src="/component---src-blog-2022-03-17-firebase-remove-unused-push-tokens-mdx-809a2466e361ed84380a.js" async=""></script><script src="/bf78b62435f1ab13ed4c16dc8a3adc67794e8876-7238c2a62e3c167833ae.js" async=""></script><script src="/app-547f3a52ec4084ef92af.js" async=""></script><script src="/framework-707a8a8db8797361392f.js" async=""></script><script src="/webpack-runtime-edd649ca7eaaa88b0b20.js" async=""></script></body></html>