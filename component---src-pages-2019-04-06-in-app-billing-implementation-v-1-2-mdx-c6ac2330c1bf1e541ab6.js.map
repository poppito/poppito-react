{"version":3,"sources":["webpack:///./src/pages/2019-04-06-In-App-Billing-implementation-v1.2.mdx","webpack:///./node_modules/@babel/runtime/helpers/esm/objectWithoutPropertiesLoose.js"],"names":["_frontmatter","layoutProps","MDXContent","components","props","mdxType","className","parentName","align","src","in_app_products","width","add_product","controls","autostart","autoPlay","video","frameBorder","allowFullScreen","isMDXComponent","_objectWithoutPropertiesLoose","source","excluded","key","i","target","sourceKeys","Object","keys","length","indexOf"],"mappings":"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","file":"component---src-pages-2019-04-06-in-app-billing-implementation-v-1-2-mdx-c6ac2330c1bf1e541ab6.js","sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\n\nimport video from './images/billing/strayamate-demo.webm';\nimport in_app_products from './images/billing/in-app-products.png';\nimport add_product from './images/billing/add-product.png';\nexport const _frontmatter = {\n  \"title\": \"In-App Billing in Android - v1.2\",\n  \"date\": \"2019-04-06 19:30 +1100\"\n};\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = \"wrapper\";\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n    <div className=\"blog\">\n      <h1>{`A continuation.`}</h1>\n      <p>{`I wrote a post about In-App Billing in Android `}<a parentName=\"p\" {...{\n          \"href\": \"2017-12-09-App-monetisation-and-In-App-Billing-implementation\"\n        }}>{`previously`}</a>{` - this is really just an update to that original post. Before we start (again) though - lets get the semantics out of the way: the API is called In-App Billing however, whenever you sell a product leveraging this API, its an In-App product (IAP).`}</p>\n      <h1>{`First things first.`}</h1>\n      <p>{`IAPs are setup in the Play console - under store presence > In-App Products. But, I wasn't able to initially set this up at all. After digging a little bit I found my production APK didn't have the In-App billing permissions. (Wouldn't this be the case for everyone?) This is easily remedied by creating an Alpha release of your app - and actually its highly recommended because you can then use test accounts to test the purchase flows. As long as your test users are added as alpha testers for your app!`}</p>\n      <p>{`Now we set up an `}<inlineCode parentName=\"p\">{`SKU`}</inlineCode>{` - a stock keeping unit - This is just a `}<inlineCode parentName=\"p\">{`String`}</inlineCode>{` value that an `}<strong parentName=\"p\">{`In-App product`}</strong>{` gets given when we generate one. Let's explore this here - we'll add an `}<strong parentName=\"p\">{`In-app product`}</strong>{` that we can bill against.`}</p>\n      <p>{`On the `}<strong parentName=\"p\">{`Play Console`}</strong>{`, under `}<strong parentName=\"p\">{`Store Presence`}</strong>{`, there is an option to create `}<strong parentName=\"p\">{`In-App products`}</strong>{` click on `}<strong parentName=\"p\">{`Add a Managed Product`}</strong>{` - then give it an id (only underscores, lowercase letters and digits allowed!) - which will become the `}<inlineCode parentName=\"p\">{`sku`}</inlineCode>{` for your `}<strong parentName=\"p\">{`In-App Product`}</strong>{`\nNext, give it a title and a description as well as price. This will show up when a user tries to buy your In-app product through your app, so make it short and simple. The Play console does automatic currency conversions for countries your app is supported in - so if you need to tweak that for individual countries - you can it here as well. Finally, click  on save and it will add your `}<inlineCode parentName=\"p\">{`In-App product`}</inlineCode>{`.`}</p>\n      <p align=\"center\">\n        <img src={in_app_products} width=\"30%\" />\n      </p>\n      <p align=\"center\">\n        <img src={add_product} width=\"30%\" />\n      </p>\n      <p>{`Now that you've got an `}<inlineCode parentName=\"p\">{`sku`}</inlineCode>{`, you can create a `}<inlineCode parentName=\"p\">{`@StringRes`}</inlineCode>{` for it.`}</p>\n      <pre><code parentName=\"pre\" {...{}}>{`    <string name=\"id_sku_my_product\">01_my_first_product</string>\n`}</code></pre>\n      <p>{`Update our permissions to use `}<inlineCode parentName=\"p\">{`In-App Billing`}</inlineCode>{` in our `}<inlineCode parentName=\"p\">{`AndroidManifest.xml`}</inlineCode>{` file.`}</p>\n      <pre><code parentName=\"pre\" {...{}}>{`    <uses-permission android:name=\"com.android.vending.BILLING\" />\n`}</code></pre>\n      <p>{`Also, to start using IAB, you will need to pull in the IAB depedency into your app. Add this to the `}<inlineCode parentName=\"p\">{`dependencies`}</inlineCode>{` closure of your app's `}<inlineCode parentName=\"p\">{`build.gradle`}</inlineCode>{`:`}</p>\n      <pre><code parentName=\"pre\" {...{}}>{`    implementation 'com.android.billingclient:billing:1.2.2'\n`}</code></pre>\n      <h1>{`The anatomy of IAB / IAPs in Android.`}</h1>\n      <p>{`Use the `}<inlineCode parentName=\"p\">{`BillingClient`}</inlineCode>{`, its your friend. When you use the `}<inlineCode parentName=\"p\">{`BillingClient`}</inlineCode>{` builder, you set a `}<inlineCode parentName=\"p\">{`PurchasesUpdatedListener`}</inlineCode>{`.`}</p>\n      <pre><code parentName=\"pre\" {...{}}>{`  billingClient = BillingClient.newBuilder(context)\n                  .setListener(this)\n                  .build();\n`}</code></pre>\n      <p>{`In order to start doing anything interesting, you call `}<inlineCode parentName=\"p\">{`startConnection()`}</inlineCode>{` and pass an instance of a `}<inlineCode parentName=\"p\">{`ConnectionStateListener`}</inlineCode>{`. This ensures connectivity of your app with the In-App Billing API. If it comes back with `}<inlineCode parentName=\"p\">{`OnBillingSetupFinished()`}</inlineCode>{`, which is the success scenario, you're ready for the next step. If it fails, it comes back with `}<inlineCode parentName=\"p\">{`OnBillingServiceDisconnected()`}</inlineCode>{`, this might warrant an error message.`}</p>\n      <pre><code parentName=\"pre\" {...{}}>{`    billing.startConnection(new BillingClientStateListener() {\n            @Override\n            public void onBillingSetupFinished(int responseCode) {\n                if (responseCode == BillingClient.BillingResponse.OK) {\n                    isBillingClientConnected = true; //this boolean value persists connection state.\n                    //do other interesting things here - as we're connected now.\n                }\n            }\n\n            @Override\n            public void onBillingServiceDisconnected() {\n               isBillingClientConnected = false;\n               //handle this failure gracefully.\n           }\n        }\n`}</code></pre>\n      <p>{`Now, we've got two things to worry about - what are the localised SKUs and their costs? So first, we query for all SKUs first. This is done by running:`}</p>\n      <pre><code parentName=\"pre\" {...{}}>{`    List<String> skuList = new ArrayList<> ();\n    skuList.add(\"premium_upgrade\");\n    skuList.add(\"gas\");\n    SkuDetailsParams.Builder params = SkuDetailsParams.newBuilder();\n    params.setSkusList(skuList).setType(SkuType.INAPP);\n    billingClient.querySkuDetailsAsync(params.build(),\n        new SkuDetailsResponseListener() {\n            @Override\n            public void onSkuDetailsResponse(int responseCode, List<SkuDetails> skuDetailsList) {\n                if (responseCode == BillingResponse.OK && skuDetailsList != null) {\n                    for (SkuDetails skuDetails : skuDetailsList) {\n                        String sku = skuDetails.getSku();\n                        String price = skuDetails.getPrice();\n                        if (\"premium_upgrade\".equals(sku)) {\n                            premiumUpgradePrice = price;\n                        } else if (\"gas\".equals(sku)) {\n                            gasPrice = price;\n                        }\n                    }\n                }\n            }\n        }\n    });\n`}</code></pre>\n      <p>{`Now that user has a list of SKUs and they want to purchase one, we start what's called a `}<inlineCode parentName=\"p\">{`BillingFlow`}</inlineCode>{`.`}</p>\n      <pre><code parentName=\"pre\" {...{}}>{`    BillingFlowParams flowParams = BillingFlowParams.newBuilder()\n        .setSkuDetails(skuDetails)\n        .build();\n    int responseCode = billingClient.launchBillingFlow(flowParams);\n`}</code></pre>\n      <p>{`Now, recall `}<inlineCode parentName=\"p\">{`OnPurchasesUpdatedListener`}</inlineCode>{` we set in the first step! That should call back if the purchase is successful!`}</p>\n      <pre><code parentName=\"pre\" {...{}}>{`    @Override\n    void onPurchasesUpdated(@BillingResponse int responseCode, List<Purchase> purchases) {\n            if (responseCode == BillingResponse.OK\n                    && purchases != null) {\n                for (Purchase purchase : purchases) {\n                    handlePurchase(purchase);\n                }\n            } else if (responseCode == BillingResponse.USER_CANCELED) {\n                // Handle an error caused by a user cancelling the purchase flow.\n            } else {\n                // Handle any other error codes.\n            }\n    }\n`}</code></pre>\n      <p>{`Nearly there! Now you can query for if the user has purchased your `}<strong parentName=\"p\">{`In-App Product`}</strong>{`. This is determined by running the `}<inlineCode parentName=\"p\">{`queryPurchaseHistoryAsync`}</inlineCode>{` callback on your `}<inlineCode parentName=\"p\">{`mBillingClient`}</inlineCode>{`.`}</p>\n      <pre><code parentName=\"pre\" {...{}}>{`    billingClient.queryPurchaseHistoryAsync(BillingClient.SkuType.INAPP, new PurchaseHistoryResponseListener() {\n                    @Override\n                    public void onPurchaseHistoryResponse(@BillingClient.BillingResponse int responseCode,\n                                                            List<Purchase> purchasesList) {\n                        if (responseCode == BillingClient.BillingResponse.OK) {\n                            if (purchasesList != null) {\n                                if (purchasesList.size() > 0) {\n                                    for (Purchase result : purchasesList) {\n                                        if (result.getSku().equals(mContext.getResources().getString(R.string.01_my_first_product))) {\n                                            //success! your user has bought your In-App product. Woohoo!\n                                        }\n                                    }\n\n                                }\n                            }\n                        }\n                    }\n                });\n`}</code></pre>\n      <p>{`Although, Android gives you some more convenience on top of this. You do not need to call `}<inlineCode parentName=\"p\">{`queryPurchaseHistoryAsync`}</inlineCode>{` everytime. Purchases are cached by the In-App Billing library - so you can just run `}<inlineCode parentName=\"p\">{`queryPurchases`}</inlineCode>{`. So, what naturally follows is that you would use this call to see if it comes back with legit `}<inlineCode parentName=\"p\">{`PurchaseResult`}</inlineCode>{`, if not you can run  `}<inlineCode parentName=\"p\">{`queryPurchaseHistoryAsync`}</inlineCode>{`.`}</p>\n      <pre><code parentName=\"pre\" {...{}}>{`    Purchase.PurchasesResult purchasesResult = mBillingClient.queryPurchases(BillingClient.SkuType.INAPP);\n                        if (purchasesResult != null) {\n                            if (purchasesResult.getPurchasesList() != null) {\n                                if (purchasesResult.getPurchasesList().size() > 0) {\n                                    for (Purchase result : purchasesResult.getPurchasesList()) {\n                                        if (result.getSku().equals(mContext.getResources().getString(R.string.01_my_first_product))) {\n                                            //success! your user has bought your In-App product. Wowie!\n                                        }\n                                    }\n                                }\n                            }\n                        }\n`}</code></pre>\n      <h1>{`Optimisation tips.`}</h1>\n      <p>{`It almost seems like you're going to have to follow the billing process twice. You're just better off using a `}<inlineCode parentName=\"p\">{`Singleton`}</inlineCode>{` instance of the `}<inlineCode parentName=\"p\">{`BillingClient`}</inlineCode>{`. If you're using a DI framework like the excellent `}<a parentName=\"p\" {...{\n          \"href\": \"https://google.github.io/dagger/\"\n        }}>{`Dagger`}</a>{`, you're better off creating a `}<inlineCode parentName=\"p\">{`Singleton`}</inlineCode>{` component on your dependency graph and then injecting it as needed.`}</p>\n      <p align=\"center\">\n <h2> Demo </h2>\n <video width=\"30%\" controls autostart autoPlay src={video} frameBorder=\"0\" allowFullScreen></video>\n </p>\n      <p><strong parentName=\"p\">{` Questions? Suggestions? Compliments? Tips to make this post better? I'd love to hear your thoughts! Tweet to `}<a parentName=\"strong\" {...{\n            \"href\": \"https://twitter.com/overjeer\"\n          }}>{`@overjeer`}</a></strong></p>\n </div>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      ","export default function _objectWithoutPropertiesLoose(source, excluded) {\n  if (source == null) return {};\n  var target = {};\n  var sourceKeys = Object.keys(source);\n  var key, i;\n\n  for (i = 0; i < sourceKeys.length; i++) {\n    key = sourceKeys[i];\n    if (excluded.indexOf(key) >= 0) continue;\n    target[key] = source[key];\n  }\n\n  return target;\n}"],"sourceRoot":""}